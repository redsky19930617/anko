<?xml version="1.0" encoding="UTF-8"?>
<project name="build_artifacts" default="build_artifacts">

    <condition property="gradlew.file" value="gradlew.bat">
        <os family="windows"/>
    </condition>

    <condition property="gradlew.file" value="./gradlew">
        <os family="mac"/>
    </condition>

    <condition property="gradlew.file" value="./gradlew">
        <and>
            <os family="unix"/>
            <not>
                <os family="mac"/>
            </not>
        </and>
    </condition>

    <target name="build_artifacts">
        <mkdir dir="workdir/zip" />

        <delete>
            <fileset dir="workdir/zip" includes="*" />
        </delete>

        <build_artifact version="21-common" artifact.name="common"/>
        <build_artifact version="15"/>
        <build_artifact version="19"/>
        <build_artifact version="21"/>
        <build_artifact version="21-support-v4"/>
        <build_artifact version="21-appcompat-v7"/>
        <build_artifact version="21-cardview-v7"/>
        <build_artifact version="21-gridlayout-v7"/>
        <build_artifact version="21-recyclerview-v7"/>
    </target>

    <macrodef name="build_artifact">
        <attribute name="version" />
        <attribute name="version.dir" default="workdir/gen/@{version}" />
        <attribute name="artifact.name" default="@{version}" />

        <sequential>
            <fail message="The directory '@{version.dir}' does not exist">
                <condition>
                    <not>
                        <available file="@{version.dir}" type="dir" />
                    </not>
                </condition>
            </fail>

            <chmod_version version.dir="@{version.dir}"/>
            <exec executable="./${gradlew.file}" dir="@{version.dir}">
                <arg value="publish"/>
            </exec>

            <delete>
                <fileset dir="@{version.dir}/build/repo/org/jetbrains/anko/anko-@{artifact.name}" includes="maven-metadata.*" />
            </delete>

            <zip destfile="workdir/zip/anko-@{artifact.name}.zip" basedir="@{version.dir}/build/repo"/>

            <copy file="@{version.dir}/build/libs/@{version}.jar"
                  tofile="workdir/zip/anko-@{artifact.name}.jar"
                  overwrite="true" />

        </sequential>
    </macrodef>

    <macrodef name="chmod_version">
        <attribute name="version.dir" />

        <sequential>
            <taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="lib/ant-contrib.jar"/>

            <if>
                <equals arg1="${gradlew.file}" arg2="gradlew.bat"/>
                <then />
                <else>
                    <exec executable="chmod">
                        <arg value="a+x"/>
                        <arg path="@{version.dir}/${gradlew.file}"/>
                    </exec>
                </else>
            </if>
        </sequential>
    </macrodef>

</project>